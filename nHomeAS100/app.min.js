function findByUsername(n,t){db.DbManager.User.find({userid:n}).success(function(n){return t(null,n)}).error(function(n){return console.log("Error::"+n),t(n,null)})}function ensureAuthenticated(n,t,i){if(n.isAuthenticated())return i();t.redirect("/login")}var express=require("express"),engine=require("ejs-locals"),routes=require("./routes"),http=require("http"),path=require("path"),flash=require("connect-flash"),passport=require("passport"),util=require("util"),LocalStrategy=require("passport-local").Strategy,db=require("./DbManager"),app;passport.serializeUser(function(n,t){console.log("Serializing user:"+n.firstName),t(null,n.id)}),passport.deserializeUser(function(n,t){db.DbManager.User.find({id:n}).success(function(n){t(null,n)}).error(function(n){t(n,null)})}),passport.use(new LocalStrategy(function(n,t,i){process.nextTick(function(){findByUsername(n,function(r,u){if(r)return i(r);if(!u)return i(null,!1,{message:"Unknown user "+n});if(u.comparePassword(t))console.log("Authentication Successful");else return i(null,!1,{message:"Invalid password"});return i(null,u)})})})),app=express(),app.set("port",process.env.PORT||3e3),app.engine("ejs",engine),app.set("views",__dirname+"/views"),app.set("view engine","ejs"),app.use(express.favicon()),app.use(express.logger("dev")),app.use(express.bodyParser()),app.use(express.methodOverride()),app.use(express.cookieParser("bnplbi1uaG9tZWFzMTAw")),app.use(express.session({secret:"bnplbi1uaG9tZWFzMTAw"})),app.use(flash()),app.use(passport.initialize()),app.use(passport.session()),app.use(app.router),app.use(express.static(path.join(__dirname,"public"))),app.set("title","nHomeAS100"),"development"==app.get("env")&&app.use(express.errorHandler()),app.get("/",routes.index),app.get("/account",ensureAuthenticated,function(n,t){t.render("account",{title:"Account",user:n.user,message:n.flash("error")})}),app.get("/login",function(n,t){t.render("login",{title:"Login",user:n.user,message:n.flash("error")})}),app.post("/login",passport.authenticate("local",{failureRedirect:"/login",failureFlash:!0}),function(n,t){console.log("Login Successful"),t.redirect("/")}),app.get("/logout",function(n,t){n.logout(),t.redirect("/")}),http.createServer(app).listen(app.get("port"),function(){console.log("Express server listening on port "+app.get("port"))})